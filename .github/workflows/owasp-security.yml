name: OWASP Security Scan

on:
  push:
    branches:
      - dev
      - test
      - staging
      - prod
    branches-ignore:
      - main
  pull_request:
    branches:
      - dev
      - test
      - staging
      - prod
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run OWASP Dependency-Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'red9inja-gpt'
        path: '.'
        format: 'HTML'
        args: >
          --enableRetired
          --enableExperimental

    - name: Upload Dependency-Check report
      uses: actions/upload-artifact@v3
      with:
        name: dependency-check-report
        path: reports/

    - name: Check for vulnerabilities
      run: |
        if [ -f "reports/dependency-check-report.html" ]; then
          echo "Dependency check completed. Review the report."
        fi

  zap-scan:
    name: OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    needs: dependency-check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'https://gpt.vmind.online'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
        allow_issue_writing: false
        fail_action: false

    - name: Upload ZAP report
      uses: actions/upload-artifact@v3
      with:
        name: zap-scan-report
        path: report_html.html

  python-security:
    name: Python Security Scan (Bandit)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Bandit
      run: pip install bandit[toml]

    - name: Run Bandit
      run: |
        bandit -r model/ api/ auth/ database/ utils/ -f json -o bandit-report.json
      continue-on-error: true

    - name: Upload Bandit report
      uses: actions/upload-artifact@v3
      with:
        name: bandit-report
        path: bandit-report.json

    - name: Run Safety check
      run: |
        pip install safety
        safety check --json > safety-report.json
      continue-on-error: true

    - name: Upload Safety report
      uses: actions/upload-artifact@v3
      with:
        name: safety-report
        path: safety-report.json

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, zap-scan, python-security]
    if: always()
    
    steps:
    - name: Download all reports
      uses: actions/download-artifact@v3

    - name: Create security summary
      run: |
        echo "## OWASP Security Scan Summary" > summary.md
        echo "" >> summary.md
        echo "All security scans completed." >> summary.md
        echo "" >> summary.md
        echo "Reports available in artifacts:" >> summary.md
        echo "- Dependency Check Report" >> summary.md
        echo "- ZAP Scan Report" >> summary.md
        echo "- Bandit Security Report" >> summary.md
        echo "- Safety Vulnerability Report" >> summary.md

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
